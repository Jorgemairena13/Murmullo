<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Murmullo</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        fieldset { background-color: #fafafa; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; padding: 15px; }
        legend { font-size: 1.2em; font-weight: bold; padding: 0 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="file"] { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 5px; }
        button:hover { background-color: #0056b3; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .config { background-color: #fffbef; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Campo de Pruebas API - Murmullo</h1>

        <fieldset class="config">
            <legend>Configuración Global</legend>
            <label for="apiBaseUrl">URL Base de la API:</label>
            <input type="text" id="apiBaseUrl" value="http://127.0.0.1:8000/api">

            <label for="authToken">Bearer Token (Obligatorio para POST/PUT/DELETE):</label>
            <input type="text" id="authToken" placeholder="Pega tu token de login aquí...">
        </fieldset>

        <fieldset>
            <legend>Crear Post (Store) - POST /posts</legend>
            <form id="createPostForm">
                <label for="postText">Texto (Opcional):</label>
                <input type="text" id="postText" name="texto" placeholder="Descripción del post...">

                <label for="postImage">Imagen (Obligatoria):</label>
                <input type="file" id="postImage" name="imagen" required>

                <button type="submit">Crear Post</button>
            </form>
        </fieldset>

        <fieldset>
            <legend>Ver Perfil de Usuario (getUserPosts) - GET /users/{id}/posts</legend>
            <label for="userId">User ID:</label>
            <input type="number" id="userId" value="1" min="1">
            <button id="fetchUserPostsBtn">Ver Perfil</button>
        </fieldset>

        <fieldset>
            <legend>Ver Todos los Posts (Index) - GET /posts</legend>
            <button id="fetchAllPostsBtn">Ver Todos</button>
        </fieldset>

        <fieldset>
            <legend>Operaciones con Post Específico</legend>
            <label for="postId">Post ID:</label>
            <input type="number" id="postId" placeholder="ID del post a ver/editar/borrar" min="1">
            <br>
            <button id="fetchPostBtn">Ver Post (Show)</button>

            <button id="deletePostBtn" class="delete">Borrar Post (Destroy)</button>

            <hr style="margin: 15px 0;">
            <label for="updateText">Nuevo Texto para Actualizar:</label>
            <input type="text" id="updateText" placeholder="Nuevo caption...">
            <button id="updatePostBtn">Actualizar Post (Update)</button>
        </fieldset>

        <fieldset>
            <legend>Respuesta de la API</legend>
            <button id="clearLogBtn" style="background-color: #6c757d;">Limpiar Log</button>
            <pre id="responseOutput">Haz clic en un botón para probar un endpoint...</pre>
        </fieldset>
    </div>

    <script>
        // --- Elementos del DOM ---
        const apiUrlInput = document.getElementById('apiBaseUrl');
        const tokenInput = document.getElementById('authToken');
        const responseOutput = document.getElementById('responseOutput');

        // Helper para obtener URL y Token
        const getApiUrl = () => apiUrlInput.value;
        const getToken = () => tokenInput.value;

        // Helper para mostrar la respuesta
        function logResponse(data) {
            responseOutput.textContent = JSON.stringify(data, null, 2);
        }

        // Helper para headers
        const getHeaders = (needsAuth = false) => {
            const headers = new Headers();
            headers.append('Accept', 'application/json');
            if (needsAuth) {
                headers.append('Authorization', `Bearer ${getToken()}`);
            }
            return headers;
        }

        // --- 1. CREAR POST (Store) ---
        document.getElementById('createPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            logResponse("Creando post...");

            const formData = new FormData();
            formData.append('texto', document.getElementById('postText').value);
            formData.append('imagen', document.getElementById('postImage').files[0]);

            try {
                const response = await fetch(`${getApiUrl()}/posts`, {
                    method: 'POST',
                    headers: getHeaders(true), // Pasa 'true' para autenticación
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw data; // Lanza el error si la API devuelve 4xx o 5xx
                logResponse(data);

            } catch (error) {
                logResponse({ error: "Error al crear post", details: error });
            }
        });

        // --- 2. VER PERFIL DE USUARIO (getUserPosts) ---
        document.getElementById('fetchUserPostsBtn').addEventListener('click', async () => {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                logResponse({ error: "Por favor, introduce un User ID." });
                return;
            }
            logResponse("Cargando perfil de usuario...");

            try {
                const response = await fetch(`${getApiUrl()}/users/${userId}/posts`, {
                    method: 'GET',
                    headers: getHeaders(true) // Perfil de usuario puede ser privado
                });

                const data = await response.json();
                if (!response.ok) throw data;
                logResponse(data);

            } catch (error) {
                logResponse({ error: `Error al obtener usuario ${userId}`, details: error });
            }
        });

        // --- 3. VER TODOS LOS POSTS (Index) ---
        document.getElementById('fetchAllPostsBtn').addEventListener('click', async () => {
            logResponse("Cargando todos los posts...");

            try {
                const response = await fetch(`${getApiUrl()}/posts`, {
                    method: 'GET',
                    headers: getHeaders(false) // El feed "Explorar" suele ser público
                });

                const data = await response.json();
                if (!response.ok) throw data;
                logResponse(data);

            } catch (error) {
                logResponse({ error: "Error al obtener posts", details: error });
            }
        });

        // --- 4. VER POST ÚNICO (Show) ---
        document.getElementById('fetchPostBtn').addEventListener('click', async () => {
            const postId = document.getElementById('postId').value;
            if (!postId) {
                logResponse({ error: "Por favor, introduce un Post ID." });
                return;
            }
            logResponse(`Cargando post ${postId}...`);

            try {
                const response = await fetch(`${getApiUrl()}/posts/${postId}`, {
                    method: 'GET',
                    headers: getHeaders(false)
                });

                const data = await response.json();
                if (!response.ok) throw data;
                logResponse(data);

            } catch (error) {
                logResponse({ error: `Error al obtener post ${postId}`, details: error });
            }
        });

        // --- 5. ACTUALIZAR POST (Update) ---
        // Usamos POST con _method: 'PUT' para simular un formulario HTML
        // y que funcione correctamente con la validación de Laravel.
        document.getElementById('updatePostBtn').addEventListener('click', async () => {
            const postId = document.getElementById('postId').value;
            const newText = document.getElementById('updateText').value;
            if (!postId) {
                logResponse({ error: "Por favor, introduce un Post ID." });
                return;
            }
            logResponse(`Actualizando post ${postId}...`);

            const formData = new FormData();
            formData.append('texto', newText);
            formData.append('_method', 'PUT'); // ¡Magia de Laravel! (Method Spoofing)

            try {
                const response = await fetch(`${getApiUrl()}/posts/${postId}`, {
                    method: 'POST', // Usamos POST para el method spoofing
                    headers: getHeaders(true),
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw data;
                logResponse(data);

            } catch (error) {
                logResponse({ error: `Error al actualizar post ${postId}`, details: error });
            }
        });

        // --- 6. BORRAR POST (Destroy) ---
        document.getElementById('deletePostBtn').addEventListener('click', async () => {
            const postId = document.getElementById('postId').value;
            if (!postId) {
                logResponse({ error: "Por favor, introduce un Post ID." });
                return;
            }
            if (!confirm(`¿Seguro que quieres borrar el post ${postId}?`)) {
                return;
            }
            logResponse(`Borrando post ${postId}...`);

            const formData = new FormData();
            formData.append('_method', 'DELETE'); // Method Spoofing

            try {
                const response = await fetch(`${getApiUrl()}/posts/${postId}`, {
                    method: 'POST', // Usamos POST para el method spoofing
                    headers: getHeaders(true),
                    body: formData
                });

                if (response.status === 204) { // 204 No Content
                    logResponse({ success: `Post ${postId} borrado correctamente.` });
                } else {
                    const data = await response.json();
                    if (!response.ok) throw data;
                    logResponse(data);
                }

            } catch (error) {
                logResponse({ error: `Error al borrar post ${postId}`, details: error });
            }
        });

        // --- LIMPIAR LOG ---
        document.getElementById('clearLogBtn').addEventListener('click', () => {
            responseOutput.textContent = 'Log limpiado.';
        });

    </script>
</body>
</html>
