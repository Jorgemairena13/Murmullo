<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario - Murmullo</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #fafafa; margin: 0; }
        .container { max-width: 935px; margin: 20px auto; padding: 20px; }
        .profile-header { display: flex; align-items: center; margin-bottom: 40px; }
        .profile-avatar { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-right: 60px; background-color: #eee; }
        .profile-info { font-size: 16px; }
        .profile-info h1 { font-size: 28px; font-weight: 300; margin: 0 0 10px; }
        .profile-info p { margin: 0 0 10px; }
        .profile-stats { display: flex; margin-bottom: 20px; }
        .profile-stats div { margin-right: 40px; }
        .posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; }
        .post { position: relative; padding-bottom: 100%; /* Aspect ratio 1:1 */ background-color: #eee; }
        .post img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #loader { text-align: center; padding: 20px; font-weight: bold; }
        #loadMoreBtn { display: none; width: 100%; padding: 10px; background-color: #3897f0; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }

        /* Configuración de prueba */
        .test-config { background: #fffbef; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .test-config label { font-weight: bold; display: block; margin-bottom: 5px; }
        .test-config input { width: 98%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">

        <div class="test-config">
            <p>¡Pega tu token aquí para que la API te deje pasar!</p>
            <label for="authToken">Tu Bearer Token:</label>
            <input type="text" id="authToken" placeholder="Pega el token que te dio el login/register...">

            <label for="userId">ID de Usuario a ver:</label>
            <input type="number" id="userId" value="1" min="1">

            <button id="loadProfileBtn" style="background-color: #28a745; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Cargar Perfil</button>
        </div>
        <header class="profile-header" id="profileHeader"></header>

        <hr>

        <div class="posts-grid" id="postsGrid"></div>

        <div id="loader">Introduce tu token y pulsa "Cargar Perfil"</div>

        <button id="loadMoreBtn">Cargar más</button>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const apiBaseUrl = 'http://127.0.0.1:8000/api';

        // --- ELEMENTOS DEL DOM ---
        const profileHeader = document.getElementById('profileHeader');
        const postsGrid = document.getElementById('postsGrid');
        const loader = document.getElementById('loader');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadProfileBtn = document.getElementById('loadProfileBtn');

        const tokenInput = document.getElementById('authToken');
        const userIdInput = document.getElementById('userId');

        let nextPageUrl = null; // Para guardar la URL de la siguiente página

        // --- FUNCIÓN PARA RENDERIZAR EL HEADER DEL PERFIL ---
        function renderProfileHeader(user) {
            // Usamos || '' para evitar que se muestre "null" o "undefined"
            const avatar = user.avatar_url || 'img/avatar_default.png'; // (pon una imagen por defecto si quieres)

            profileHeader.innerHTML = `
                <img src="${avatar}" alt="Avatar de ${user.nombre}" class="profile-avatar">
                <div class="profile-info">
                    <h1>${user.nombre}</h1>
                    <div class="profile-stats">
                        <div><strong>${user.posts_count}</strong> publicaciones</div>
                    </div>
                    <p><strong>${user.nombre}</strong></p>
                    <p>${user.bio || ''}</p>
                </div>
            `;
        }

        // --- FUNCIÓN PARA RENDERIZAR POSTS ---
        function renderPosts(posts) {
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';

                const imgElement = document.createElement('img');
                // ¡Esto ya viene como URL completa desde tu PostResource!
                imgElement.src = post.imagen_url;
                imgElement.alt = post.texto || 'Publicación de usuario';

                postElement.appendChild(imgElement);
                postsGrid.appendChild(postElement);
            });
        }

        // --- FUNCIÓN PRINCIPAL PARA CARGAR EL PERFIL ---
        async function fetchUserProfile(url) {
            const token = tokenInput.value;

            // Verificación simple
            if (!token) {
                loader.textContent = 'Error: Falta el Bearer Token.';
                return;
            }

            loader.style.display = 'block';
            loadMoreBtn.style.display = 'none';

            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}` // ¡La autenticación!
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Token no válido o caducado. Vuelve a hacer login.');
                    }
                    if (response.status === 404) {
                        throw new Error('Usuario no encontrado.');
                    }
                    throw new Error(`Error en la petición: ${response.statusText}`);
                }

                const data = await response.json();

                // Renderizar el header del perfil (solo la primera vez)
                if (!profileHeader.innerHTML) {
                    renderProfileHeader(data.user);
                }

                // Renderizar los posts de la página actual
                renderPosts(data.posts);

                // Guardar la URL de la siguiente página
                nextPageUrl = data.posts.next_page_url;

                // Mostrar u ocultar el botón "Cargar más"
                if (nextPageUrl) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }

            } catch (error) {
                loader.textContent = `Error al cargar el perfil: ${error.message}`;
                console.error('Error:', error);
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- EVENT LISTENER PARA EL BOTÓN "CARGAR MÁS" ---
        loadMoreBtn.addEventListener('click', () => {
            if (nextPageUrl) {
                fetchUserProfile(nextPageUrl);
            }
        });

        // --- EVENT LISTENER PARA EL BOTÓN "CARGAR PERFIL" ---
        loadProfileBtn.addEventListener('click', () => {
            // Limpiamos el contenido anterior antes de cargar uno nuevo
            profileHeader.innerHTML = '';
            postsGrid.innerHTML = '';
            nextPageUrl = null;

            const userId = userIdInput.value;
            const initialUrl = `${apiBaseUrl}/users/${userId}/posts`;
            fetchUserProfile(initialUrl);
        });

    </script>
</body>
</html>
